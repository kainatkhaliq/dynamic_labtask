version: 0.2

phases:
  install:
    commands:
      # Update system packages
      - echo "Starting installation phase..."
      - sudo apt-get update
      
      # Install NGINX
      - sudo apt-get install -y nginx

      # Install Node.js (example: using Node.js 16 LTS)
      - curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
      - sudo apt-get install -y nodejs
      
      # Verify installations
      - node -v
      - npm -v
      - nginx -v

  build:
    commands:
      # Echo build date
      - echo "Build started on: $(date)"
      
      # Install application dependencies
      - npm install
      
      # Build or prepare the application (if applicable)
      - npm run build  # Adjust this if you don't use a build step
      
      # Copy application files to the NGINX directory
      - sudo cp -r * /var/www/html/
      
      # Optionally set file permissions
      - sudo chmod -R 755 /var/www/html/

  post_build:
    commands:
      # Configure NGINX to act as a reverse proxy for the dynamic app
      - echo "Configuring NGINX..."
      - sudo mv /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bak
      - |
        echo '
        server {
            listen 80;
            server_name localhost;

            location / {
                proxy_pass http://localhost:3000;  # Forward requests to the Node.js server
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_cache_bypass $http_upgrade;
            }
        }
        ' | sudo tee /etc/nginx/sites-available/default

      # Restart NGINX to apply changes
      - sudo systemctl restart nginx
      - echo "NGINX restarted and proxy setup completed."

      # Start the Node.js application
      - echo "Starting the Node.js application..."
      - nohup npm start &  # Run the app in the background

artifacts:
  files:
    # Include application artifacts (if any)
    - /var/www/html/*
